name: Deploy Portfolio & Auth to AWS (Smart Deploy)

on:
  push:
    branches:
      - main

jobs:
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      portfolio: ${{ steps.changes.outputs.portfolio }}
      auth: ${{ steps.changes.outputs.auth }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 2

      - name: Check for changes
        id: changes
        run: |
          if git diff --name-only HEAD^ HEAD | grep -q "^Profil/"; then
            echo "portfolio=true" >> $GITHUB_OUTPUT
          else
            echo "portfolio=false" >> $GITHUB_OUTPUT
          fi
          
          if git diff --name-only HEAD^ HEAD | grep -q "^Auth/AuthWithJWT/"; then
            echo "auth=true" >> $GITHUB_OUTPUT
          else
            echo "auth=false" >> $GITHUB_OUTPUT
          fi

  deploy-portfolio:
    name: Deploy Portfolio App
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.portfolio == 'true'
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Build Portfolio App
        working-directory: ./Profil
        run: mvn clean package -DskipTests

      - name: Generate Portfolio deployment package
        run: |
          mkdir deploy-portfolio
          cp Profil/target/*.jar deploy-portfolio/portfolio.jar
          cd deploy-portfolio
          zip -r portfolio.zip .

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Upload Portfolio to S3
        run: aws s3 cp deploy-portfolio/portfolio.zip s3://${{ secrets.S3_BUCKET }}/portfolio-${{ github.sha }}.zip

      - name: Create Portfolio application version
        run: |
          aws elasticbeanstalk create-application-version \
            --application-name arafet-ferdjani \
            --version-label "portfolio-${{ github.sha }}" \
            --source-bundle S3Bucket="${{ secrets.S3_BUCKET }}",S3Key="portfolio-${{ github.sha }}.zip"

      - name: Deploy Portfolio
        run: |
          aws elasticbeanstalk update-environment \
            --environment-name Arafet-ferdjani-env \
            --version-label "portfolio-${{ github.sha }}"

  deploy-auth:
    name: Deploy Auth App
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.auth == 'true'
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Build Auth App
        working-directory: ./Auth/AuthWithJWT
        run: mvn clean package -DskipTests

      - name: Generate Auth deployment package
        run: |
          mkdir deploy-auth
          cp Auth/AuthWithJWT/target/*.jar deploy-auth/auth.jar
          cd deploy-auth
          zip -r auth.zip .

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Upload Auth to S3
        run: aws s3 cp deploy-auth/auth.zip s3://${{ secrets.S3_BUCKET }}/auth-${{ github.sha }}.zip

      - name: Create Auth application version
        run: |
          aws elasticbeanstalk create-application-version \
            --application-name arafet-ferdjani \
            --version-label "auth-${{ github.sha }}" \
            --source-bundle S3Bucket="${{ secrets.S3_BUCKET }}",S3Key="auth-${{ github.sha }}.zip"

      - name: Deploy Auth
        run: |
          aws elasticbeanstalk update-environment \
            --environment-name Arafet-ferdjani-env \
            --version-label "auth-${{ github.sha }}"
